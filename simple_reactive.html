<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified reactive implementation</title>
</head>

<body>
    <script>

        /**
         * This function sets up an object to be reactive.
         * @param {object} target - The object to be made reactive.
         * @returns {object} A Proxy of the object parameter passed in.
         */
        function reactive(target) {

            //Set of functions to be called when the value of the "object" changes.
            const _listeners = new Set();

            //The passed in object wrapped in a proxy object.  This will allow us to intercept calls to the object and make the reactivity work.
            const _proxy = new Proxy(target, {
                get(target, property, receiver) {
                    return Reflect.get(target, property, receiver);
                },
                //when value is updated on the target it gets intercepted here
                set(target, property, value, receiver) {
                    const result = Reflect.set(target, property, value, receiver);

                    //and all the listeners get called
                    _listeners.forEach(fn => fn());
                    return result;
                }
            });

            //add a listener to the proxy
            _proxy.subscribe = function (fn) {
                _listeners.add(fn);
            };
            //remove a listener from the proxy
            _proxy.unsubscribe = function (fn) {
                _listeners.delete(fn);
            };

            return _proxy;
        }

        /**
         * This class represents a high level Component that will rerender itself when a the data changes
         */
        class Component {
            constructor(options) {
                this.template = options.template;

                //the data property becomes reactive after this call
                //this.data becomes a Proxy to options.data()
                this.data = reactive(options.data());

                this.methods = options.methods;
                this.style = options.style;
                this.root = options.root;

                // if the root element for this component is not found then create it.
                if (!document.getElementById(this.root)) {
                    const rootElement = document.createElement('div');
                    rootElement.id = this.root;
                    document.body.appendChild(rootElement);
                }

                //at this point this.data is a Proxy.  Calling subscribe will add the render function to the list of subscribers
                //when this.data changes this.render will be called.
                this.data.subscribe(this.render.bind(this));
                this.render();
            }
            //Replaces the {{}} syntax with actual values
            compileTemplate(template) {
                //matches the specified syntax to show a reactive bit of data
                // should be of the format '{{ }}' in the template
                const match = template.match(/{{\s*(\w+)\s*}}/g);
                return () => {
                    let compiledTemplate = template;
                    if (match) {
                        //if there is a match replace the literal {{ }} with the value in the data object
                        match.forEach(item => {
                            const key = item.replace(/{{\s*|\s*}}/g, '');
                            //replace the {{}} with the actual value.
                            compiledTemplate = compiledTemplate.replace(item, this.data[key]);
                        });
                    }
                    return compiledTemplate;
                };
            }

            render() {
                const el = document.getElementById(this.root);
                if (el) {
                    el.innerHTML = this.compileTemplate(this.template)();
                    this.applyMethods(el);
                }
            }

            applyMethods(el) {
                Object.keys(this.methods).forEach(methodName => {
                    const matches = el.querySelectorAll(`[data-action="${methodName}"]`);
                    matches.forEach(match => {
                        match.onclick = this.methods[methodName].bind(this.data);
                    });
                });
            }
        }

        const ReactiveComponent = new Component({
            template: `
          <div class="my-component">
            <div class="container">
              <p class="display">Count: {{ count }}</p>
              <div class="buttons">
                <button data-action="increment">+</button>
                <button data-action="decrement">-</button>
              </div>
            </div>
          </div>
        `,
            data() {
                return {
                    count: 0
                };
            },
            methods: {
                increment() {
                    this.count += 1;
                },
                decrement() {
                    this.count -= 1;
                }
            },
            style: `
          .my-component {
            text-align: center;
            padding: 50px;
            background: grey;
          }
          .my-component .container {
            background: white;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
          }
          .my-component .display {
            font-size: 24px;
            margin-bottom: 20px;
          }
          .my-component .buttons button {
            font-size: 16px;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            
          }
          .my-component .buttons button:hover {
            background: #ddd;
          }
          .my-component .buttons button:active {
            background: #ccc;
          }
        `,
            root: 'my_id' // Specify the ID for the root element
        });

        const style = document.createElement('style');
        style.textContent = ReactiveComponent.style;
        document.head.appendChild(style);
    </script>
</body>

</html>